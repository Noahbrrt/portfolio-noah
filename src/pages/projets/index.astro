---
import Layout from "../../layouts/Layout.astro";
import pb from "../../utils/pb";

const records = await pb.collection("projects").getFullList({
  sort: "year,-created",
});

const projects = records.map((project) => {
  const cover = project.cover
    ? pb.files.getURL(project, project.cover, { thumb: "1200x900" })
    : null;

  const tools = Array.isArray(project.tools)
    ? project.tools
    : project.tools
    ? [project.tools]
    : [];

  return {
    id: project.id,
    title: project.title,
    slug: project.slug,
    description: project.description,
    category: project.category,
    year: project.year,
    tools,
    behanceUrl: project.behanceUrl || null,
    cover,
  };
});
---

<Layout title="Projets — Noah Barret">
  <main class="relative min-h-screen pt-20 md:pt-32 pb-12 md:pb-16 text-white overflow-hidden">
    {/* Décor de fond */}
    <img
      src="/wavebar-apropos.svg"
      alt=""
      loading="lazy"
      class="pointer-events-none absolute inset-x-0 top-[-10rem] w-full max-w-none opacity-[0.12] mix-blend-screen z-0"
    />

    <div class="relative z-10 max-w-6xl mx-auto px-4 sm:px-6 space-y-8">
      {/* Titre + intro */}
      <header class="space-y-4">
        <p class="text-[0.7rem] uppercase tracking-[0.35em] text-fuchsia-300/80">
          Projets
        </p>
        <h1 class="text-2xl sm:text-3xl md:text-5xl font-semibold tracking-tight">
          Une selection de projets qui me ressemblent.
        </h1>
        <p class="text-xs sm:text-sm md:text-base text-white/75 max-w-2xl leading-relaxed">
           Affiches de joueurs, refonte de site associatif, projet web autour de
          la cybersécurité… Fais défiler, et découvre chaque projet comme une
          carte à part entière.
        </p>
      </header>

      <section class="space-y-6">

        <div class="relative -mx-4 md:-mx-10 lg:-mx-12">
          <div class="pointer-events-none absolute inset-0 bg-gradient-to-r from-fuchsia-500/8 via-transparent to-indigo-500/8 blur-3xl"></div>

          <div
            class="pointer-events-none absolute inset-y-0 left-0 w-24 md:w-40 bg-gradient-to-r from-[#170040] via-[#170040]/40 to-transparent z-20"
            aria-hidden="true"
          ></div>
          <div
            class="pointer-events-none absolute inset-y-0 right-0 w-24 md:w-40 bg-gradient-to-l from-[#170040] via-[#170040]/40 to-transparent z-20"
            aria-hidden="true"
          ></div>

          <button
            id="projects-prev"
            type="button"
            aria-label="Projet précédent"
            class="flex md:flex absolute top-1/2 left-2 md:left-4 lg:left-6 -translate-y-1/2
                   items-center justify-center p-2 md:p-0 touch-manipulation
                   bg-[#170040]/30 md:bg-transparent rounded-md md:rounded-none
                   transition-colors transition-transform duration-300 z-30
                   hover:scale-110"
          >
            <div class="arrow-button arrow-button--left">
              <div class="arrow-line one">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line two">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line three">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line four">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line five">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line six">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line seven">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
            </div>
          </button>

          <button
            id="projects-next"
            type="button"
            aria-label="Projet suivant"
            class="flex md:flex absolute top-1/2 right-2 md:right-4 lg:right-6 -translate-y-1/2
                   items-center justify-center p-2 md:p-0 touch-manipulation
                   bg-[#170040]/30 md:bg-transparent rounded-md md:rounded-none
                   transition-colors transition-transform duration-300 z-30
                   hover:scale-110"
          >
            <div class="arrow-button">
              <div class="arrow-line one">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line two">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line three">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line four">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line five">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line six">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
              <div class="arrow-line seven">
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
                <div class="arrow-round"></div>
              </div>
            </div>
          </button>

          <div
            id="projects-carousel"
            class="projects-carousel relative flex gap-4 md:gap-8 overflow-x-auto px-4 md:px-10 lg:px-12 py-2 snap-x snap-mandatory"
          >
            {projects.map((project, index) => (
              <article
                class="snap-center shrink-0 w-[96vw] sm:w-[90vw] md:w-[70vw] lg:w-[62vw]
                       rounded-xl md:rounded-[1.25rem] border border-white/8 bg-gradient-to-br from-white/6 to-white/2
                       backdrop-blur-md shadow-[0_12px_32px_rgba(0,0,0,0.4)]
                       relative group overflow-hidden transition-all duration-500
                       hover:shadow-[0_20px_56px_rgba(139,0,255,0.15)] hover:-translate-y-1 hover:border-fuchsia-500/25"
              >
                <div
                  class="pointer-events-none absolute -inset-px rounded-[1.25rem] 
                         bg-gradient-to-br from-fuchsia-500/35 via-purple-500/10 to-sky-400/25 
                         opacity-60 md:opacity-0 md:group-hover:opacity-100 blur-lg transition duration-500"
                  aria-hidden="true"
                ></div>

                <div class="relative p-6 md:p-7 lg:p-8">
                  <div class="grid gap-4 md:gap-6 md:grid-cols-[1.3fr_minmax(0,1fr)] items-stretch">
                    <div class="relative overflow-hidden rounded-xl bg-black/30 h-48 sm:h-56 md:h-72 lg:h-80">
                      {project.cover && (
                        <img
                          src={project.cover}
                          alt={project.title}
                          loading="lazy"
                          class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-[1.04]"
                        />
                      )}
                      <div class="absolute inset-0 bg-gradient-to-t from-[#170040]/80 via-transparent to-transparent"></div>

                      <div class="absolute inset-4 flex items-end justify-between">
                        <div class="flex flex-col gap-2">
                          <span
                            class="inline-flex rounded-full bg-fuchsia-500/85 px-3 py-1 text-[0.65rem] font-bold uppercase tracking-[0.2em] w-fit"
                          >
                            {project.category}
                          </span>
                          {project.year && (
                            <span class="text-xs text-white/70 font-medium">
                              {project.year}
                            </span>
                          )}
                        </div>
                        <span class="text-3xl md:text-4xl font-semibold text-white/15">
                          {String(index + 1).padStart(2, "0")}
                        </span>
                      </div>
                    </div>

                    <div class="flex flex-col justify-between gap-3">
                      <div class="space-y-2">
                        <h2 class="text-base md:text-xl font-semibold leading-tight tracking-tight">
                          {project.title}
                        </h2>
                        <p class="text-xs md:text-sm text-white/85 md:text-white/70 leading-relaxed line-clamp-3">
                          {project.description}
                        </p>
                      </div>

                      <div class="space-y-2">
                        {project.tools.length > 0 && (
                          <div class="flex flex-wrap gap-1.5">
                            {project.tools.map((tool) => (
                              <span
                                class="inline-flex rounded-full border border-white/10 bg-white/4 px-2.5 py-1 text-[0.6rem] text-white/70 font-medium"
                              >
                                {tool}
                              </span>
                            ))}
                          </div>
                        )}

                        <div class="flex items-center gap-3 pt-1">
                          <a
                            href={`/projets/${project.id}`}
                            class="inline-flex items-center gap-1.5 rounded-full bg-fuchsia-500/80 border border-fuchsia-400/50 px-5 py-2 text-[0.7rem] font-bold uppercase tracking-[0.15em] transition-all duration-300 hover:bg-fuchsia-500 hover:border-fuchsia-300 hover:shadow-[0_12px_28px_rgba(217,70,239,0.25)]"
                          >
                            Voir
                            <span aria-hidden="true">↗</span>
                          </a>
                          {project.behanceUrl && (
                            <a
                              href={project.behanceUrl}
                              target="_blank"
                              rel="noreferrer"
                              class="text-[0.7rem] text-white/50 hover:text-fuchsia-300 underline underline-offset-2 transition hover:underline-offset-4"
                            >
                              Behance
                            </a>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      </section>
    </div>
  </main>

  <style>
    .projects-carousel {
      scrollbar-width: none; 
      -webkit-overflow-scrolling: touch;
      /* allow vertical scrolling to bubble to the page */
      overscroll-behavior-y: auto;
      touch-action: auto;
    }
    .projects-carousel::-webkit-scrollbar {
      display: none; 
    }
  </style>

  <script is:inline>
    window.addEventListener("DOMContentLoaded", () => {
      const carousel = document.getElementById("projects-carousel");
      if (!carousel) return;

      const prevBtn = document.getElementById("projects-prev");
      const nextBtn = document.getElementById("projects-next");

      const scrollAmount = () => carousel.clientWidth * 0.85;

      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          carousel.scrollBy({ left: -scrollAmount(), behavior: "smooth" });
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          carousel.scrollBy({ left: scrollAmount(), behavior: "smooth" });
        });
      }
    });
  </script>
</Layout>
